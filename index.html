<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seattle Car Crashes</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }
    #map {
      position: absolute;
      top: 0; bottom: 0;
      width: 100%;
    }
    .map-overlay {
      position: absolute;
      margin: 12px;
      background-color: #fff;
      border-radius: 3px;
      z-index: 2;
      font-size: 14px;
      line-height: 1.3;
      padding: 10px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    #legend {
      top: 10px;
      left: 10px;
    }
    #controls {
      top: 10px;
      right: 10px;
      width: 200px;
    }
    #timeSliderContainer {
      bottom: 20px;
      width: 80%;
      left: 10%;
      text-align: center;
    }
    #timeSlider {
      width: 80%;
    }
    #toggleBtn {
      margin-bottom: 10px;
      width: 100%;
    }
    label {
      display: block;
      margin: 5px 0;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="legend" class="map-overlay">
  <strong>Legend</strong>
  <p id="legend-heatmap" style="display: none;">Heatmap: Higher density = Red, Lower = Green</p>
  <p id="legend-points" style="display: block;">Dot Map: Each dot = One crash</p>
</div>

<div id="controls" class="map-overlay">
  <button id="toggleBtn">Switch to Heatmap</button>
  <hr>
  <label for="severityFilter"><strong>SEVERITYDESC</strong></label>
  <select id="severityFilter">
    <option value="all">All Severities</option>
  </select>

  <label for="collisionTypeFilter"><strong>COLLISIONTYPE</strong></label>
  <select id="collisionTypeFilter">
    <option value="all">All Types</option>
  </select>
</div>

<div id="timeSliderContainer" class="map-overlay">
  <input type="range" id="timeSlider" min="2016" max="2020" step="4" value="2016" />
  <p>Year: <span id="sliderYear">2016</span></p>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiamVybXRhbiIsImEiOiJjbTZ0dWJrdTEwNm85MnJwdDkwMnRnbWdzIn0.veXha7dQKwAH_U5gHXIXQg';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-122.3321, 47.6062],
    zoom: 11
  });

  fetch('cleanedData/Filtered_Collisions_Data__2016___2020_.geojson')
    .then(response => response.json())
    .then(data => {
      map.on('load', () => {
        map.addSource('collisions', { type: 'geojson', data });

        map.addLayer({
          id: 'collisions-heat',
          type: 'heatmap',
          source: 'collisions',
          maxzoom: 16,
          paint: {
            'heatmap-intensity': [
              'interpolate',
              ['linear'],
              ['zoom'],
              0, 0.5,
              15, 1.5
            ],
            'heatmap-color': [
              'interpolate',
              ['linear'],
              ['heatmap-density'],
              0, 'rgba(0,255,0,0)', // Transparent green
              0.3, 'rgba(0,255,0,0.8)', // Green
              0.6, 'rgba(255,255,0,0.8)', // Yellow
              1, 'rgba(255,0,0,0.8)' // Red
            ],
            'heatmap-radius': [
              'interpolate',
              ['linear'],
              ['zoom'],
              0, 2,
              9, 20
            ],
            'heatmap-opacity': 0.8
          },
          layout: { 'visibility': 'none' }
        });

        map.addLayer({
          id: 'collisions-circle',
          type: 'circle',
          source: 'collisions',
          paint: {
            'circle-radius': 4,
            'circle-color': ['match', ['get', 'SEVERITYDESC'], 'Injury Collision', '#e55e5e', 'Property Damage Only Collision', '#3bb2d0', '#ccc'],
            'circle-opacity': 0.7
          },
          layout: { 'visibility': 'visible' }
        });

        populateFilters(data);
      });
    })
    .catch(error => console.error('Error loading GeoJSON:', error));

  const toggleBtn = document.getElementById('toggleBtn');
  let isHeatmapVisible = false;

  toggleBtn.addEventListener('click', () => {
    isHeatmapVisible = !isHeatmapVisible;
    map.setLayoutProperty('collisions-heat', 'visibility', isHeatmapVisible ? 'visible' : 'none');
    map.setLayoutProperty('collisions-circle', 'visibility', isHeatmapVisible ? 'none' : 'visible');
    toggleBtn.textContent = isHeatmapVisible ? 'Switch to Dot Density' : 'Switch to Heatmap';
    document.getElementById('legend-heatmap').style.display = isHeatmapVisible ? 'block' : 'none';
    document.getElementById('legend-points').style.display = isHeatmapVisible ? 'none' : 'block';
  });

  const timeSlider = document.getElementById('timeSlider');
  const sliderYearLabel = document.getElementById('sliderYear');

  timeSlider.addEventListener('input', () => {
    sliderYearLabel.textContent = timeSlider.value;
    filterData();
  });

  const severityFilter = document.getElementById('severityFilter');
  const collisionTypeFilter = document.getElementById('collisionTypeFilter');

  severityFilter.addEventListener('change', filterData);
  collisionTypeFilter.addEventListener('change', filterData);

  function filterData() {
    const selectedYear = parseInt(timeSlider.value, 10);
    const selectedSeverity = severityFilter.value;
    const selectedCollisionType = collisionTypeFilter.value;

    let filters = ['all'];

    filters.push([
      '==',
      ['number', ['to-number', ['slice', ['get', 'INCDATE'], 0, 4]]], 
      selectedYear
    ]);

    if (selectedSeverity !== 'all') {
      filters.push(['==', ['get', 'SEVERITYDESC'], selectedSeverity]);
    }

    if (selectedCollisionType !== 'all') {
      filters.push(['==', ['get', 'COLLISIONTYPE'], selectedCollisionType]);
    }

    map.setFilter('collisions-heat', filters);
    map.setFilter('collisions-circle', filters);
  }

  function populateFilters(data) {
    let severityOptions = new Set(), collisionOptions = new Set();
    data.features.forEach(f => {
      severityOptions.add(f.properties.SEVERITYDESC);
      collisionOptions.add(f.properties.COLLISIONTYPE);
    });

    severityOptions.forEach(severity => severityFilter.innerHTML += `<option value="${severity}">${severity}</option>`);
    collisionOptions.forEach(type => collisionTypeFilter.innerHTML += `<option value="${type}">${type}</option>`);
  }
</script>

</body>
</html>
